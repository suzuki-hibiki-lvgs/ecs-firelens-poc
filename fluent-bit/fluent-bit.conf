# ===========================================
# Fluent Bit Configuration - Local Development
# ===========================================
# ECS FireLens構成のローカルシミュレーション
# docker-compose.ymlからvolume mountで使用される
#
# 用途: ローカル開発・テスト
# ECS用設定: extra.conf（FireLens用、OUTPUTのみ）

[SERVICE]
    Flush         1
    Daemon        Off
    Log_Level     info
    Parsers_File  /fluent-bit/etc/parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# -------------------------------------------
# INPUT: Forward (fluentd protocol)
# -------------------------------------------
# docker-compose のfluentd logging driverからログを受信
[INPUT]
    Name          forward
    Listen        0.0.0.0
    Port          24224
    Tag           app-firelens

# -------------------------------------------
# FILTER: JSON Parser
# -------------------------------------------
# アプリケーションのJSON形式ログをパース
[FILTER]
    Name          parser
    Match         app-firelens*
    Key_Name      log
    Parser        json
    Reserve_Data  On
    Preserve_Key  Off

# -------------------------------------------
# FILTER: Metadata 付与
# -------------------------------------------
# ローカル環境用のメタデータを追加
[FILTER]
    Name          record_modifier
    Match         app-firelens*
    Record        environment local
    Record        ecs_cluster local-cluster
    Record        ecs_task_arn arn:aws:ecs:ap-northeast-1:000000000000:task/local-task

# -------------------------------------------
# FILTER: ログルーティング (New Relic用)
# -------------------------------------------
# ERROR レベルのログを logs.newrelic タグに複製
[FILTER]
    Name          rewrite_tag
    Match         app-firelens*
    Rule          $level ^(ERROR)$ logs.newrelic.$TAG true
    Emitter_Name  re_emitted_nr_error

# WARN レベルのログを logs.newrelic タグに複製
[FILTER]
    Name          rewrite_tag
    Match         app-firelens*
    Rule          $level ^(WARN)$ logs.newrelic.$TAG true
    Emitter_Name  re_emitted_nr_warn

# -------------------------------------------
# FILTER: ログルーティング (S3用)
# -------------------------------------------
# 全ログを logs.s3 タグに複製
[FILTER]
    Name          rewrite_tag
    Match         app-firelens*
    Rule          $level .+ logs.s3.$TAG false
    Emitter_Name  re_emitted_s3

# -------------------------------------------
# OUTPUT: New Relic Simulation (stdout)
# -------------------------------------------
# ローカル環境ではstdoutに出力してNew Relic送信をシミュレート
# 実際のNew Relic送信はECS環境のextra.confで行う
[OUTPUT]
    Name          stdout
    Match         logs.newrelic.*
    Format        json_lines

# -------------------------------------------
# OUTPUT: S3 Simulation (stdout)
# -------------------------------------------
# ローカル環境ではstdoutに出力してS3送信をシミュレート
# 実際のFirehose送信はECS環境のextra.confで行う
[OUTPUT]
    Name          stdout
    Match         logs.s3.*
    Format        json_lines
