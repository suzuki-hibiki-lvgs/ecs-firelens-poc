# ===========================================
# Fluent Bit Configuration - Phase 1.5
# ===========================================
# ECS FireLens PoC - ログ出し分けロジック検証
# - New Relic: ERROR/WARN のみ（コスト削減）
# - S3: 全ログ（コンプライアンス対応）

[SERVICE]
    Flush         1
    Daemon        Off
    Log_Level     info
    Parsers_File  /fluent-bit/etc/parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# -------------------------------------------
# INPUT: Forward (fluentd protocol)
# -------------------------------------------
[INPUT]
    Name          forward
    Listen        0.0.0.0
    Port          24224
    Tag           app-firelens

# -------------------------------------------
# FILTER: JSON Parser
# -------------------------------------------
[FILTER]
    Name          parser
    Match         app-firelens*
    Key_Name      log
    Parser        json
    Reserve_Data  On
    Preserve_Key  Off

# -------------------------------------------
# FILTER: Metadata 付与
# -------------------------------------------
[FILTER]
    Name          record_modifier
    Match         app-firelens*
    Record        environment local
    Record        ecs_cluster local-cluster
    Record        ecs_task_arn arn:aws:ecs:ap-northeast-1:000000000000:task/local-task

# -------------------------------------------
# FILTER: ログルーティング (New Relic用)
# -------------------------------------------
# ERROR レベルのログを logs.newrelic タグに複製
# Keep On: 元のレコードを保持（S3用に残す）
[FILTER]
    Name          rewrite_tag
    Match         app-firelens*
    Rule          $level ^(ERROR)$ logs.newrelic.$TAG true
    Emitter_Name  re_emitted_nr_error

# WARN レベルのログを logs.newrelic タグに複製
[FILTER]
    Name          rewrite_tag
    Match         app-firelens*
    Rule          $level ^(WARN)$ logs.newrelic.$TAG true
    Emitter_Name  re_emitted_nr_warn

# -------------------------------------------
# FILTER: ログルーティング (S3用)
# -------------------------------------------
# 全ログを logs.s3 タグに複製
[FILTER]
    Name          rewrite_tag
    Match         app-firelens*
    Rule          $level .+ logs.s3.$TAG false
    Emitter_Name  re_emitted_s3

# -------------------------------------------
# OUTPUT: New Relic (ERROR/WARN only)
# -------------------------------------------
# Phase 2 で実際の New Relic 送信に置き換え
# 現在は stdout で動作確認
[OUTPUT]
    Name          stdout
    Match         logs.newrelic.*
    Format        json_lines
    # 識別用にプレフィックスを追加
    Json_date_key @timestamp_nr

# -------------------------------------------
# OUTPUT: S3 (All logs)
# -------------------------------------------
# Phase 2 で Kinesis Firehose 送信に置き換え
# 現在は stdout で動作確認
[OUTPUT]
    Name          stdout
    Match         logs.s3.*
    Format        json_lines
    # 識別用にプレフィックスを追加
    Json_date_key @timestamp_s3
