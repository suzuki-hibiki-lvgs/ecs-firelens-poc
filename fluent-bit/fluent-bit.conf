# ===========================================
# Fluent Bit Configuration - Phase 1 (Local)
# ===========================================
# ECS FireLens PoC - ローカル検証用設定
# Phase 1: JSON パース + stdout 出力

[SERVICE]
    # Flush間隔（秒）
    Flush         1
    # デーモンモード無効（フォアグラウンド実行）
    Daemon        Off
    # ログレベル
    Log_Level     info
    # パーサー設定ファイル
    Parsers_File  /fluent-bit/etc/parsers.conf
    # ヘルスチェック用HTTPサーバー
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# -------------------------------------------
# INPUT: Forward (fluentd protocol)
# -------------------------------------------
# Docker logging driver からのログを受信
# ECS FireLens と同じプロトコル
[INPUT]
    Name          forward
    Listen        0.0.0.0
    Port          24224
    Tag           app-firelens

# -------------------------------------------
# FILTER: JSON Parser
# -------------------------------------------
# アプリのログ（JSON文字列）を構造化データにパース
[FILTER]
    Name          parser
    Match         app-firelens*
    Key_Name      log
    Parser        json
    # パース成功時に元の log フィールドを保持しない
    Reserve_Data  On
    Preserve_Key  Off

# -------------------------------------------
# FILTER: Metadata 付与
# -------------------------------------------
# 環境情報などのメタデータを追加（ECSメタデータのモック）
[FILTER]
    Name          record_modifier
    Match         app-firelens*
    Record        environment local
    Record        ecs_cluster local-cluster
    Record        ecs_task_arn arn:aws:ecs:ap-northeast-1:000000000000:task/local-task

# -------------------------------------------
# OUTPUT: Standard Output (Phase 1)
# -------------------------------------------
# 動作確認用 - 全ログを標準出力に表示
[OUTPUT]
    Name          stdout
    Match         *
    Format        json_lines
